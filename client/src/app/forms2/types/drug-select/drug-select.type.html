<nz-row [nzGutter]="[8, 8]">
  <nz-col nzFlex="auto">
    <cvc-entity-select
      [cvcSelectMode]="props.isMultiSelect ? 'multiple' : 'default'"
      [cvcCustomTemplate]="selectedTemplate"
      [cvcFormControl]="formControl"
      [cvcFormlyAttributes]="field"
      [cvcEntityName]="props.entityName"
      [cvcResults]="result$ | ngrxPush"
      [cvcOptions]="(selectOption$ | ngrxPush)!"
      [cvcShowError]="showError"
      [cvcDisabled]="!(onRequiresDrug$ | ngrxPush)"
      [cvcLoading]="isLoading$ | ngrxPush"
      [cvcOptionTrackBy]="optionTrackBy"
      [cvcAddEntity]="addDrug"
      (cvcOnSearch)="onSearch$.next($event)"
      [cvcModelChange]="props.change">
    </cvc-entity-select>

    <!-- select option templates, view containers -->
    <!-- references are used to create select option templates in getOptionTemplate() -->
    <ng-container *ngrxLet="onSearch$ as searchString">
      <ng-container *ngFor="let result of result$ | ngrxPush; index as i">
        <ng-template #optionTemplates>
          {{ searchString }} {{ result.name }}
        </ng-template>
      </ng-container>
    </ng-container>

    <ng-template #optionTemplate>
      <ng-container
        #optionContext
        [ngTemplateOutlet]="optionContents">
      </ng-container>
      <ng-template #optionContents>OPTION</ng-template>
    </ng-template>
    <!-- selected option item template -->
    <!-- displays entity tag, specifying context and mode depending on
if field is multi-select or single -->
    <ng-template
      #selectedTemplate
      let-selected>
      <div class="ant-select-selection-item-content">
        <cvc-entity-tag
          [cvcCacheId]="'Drug:' + selected.nzValue"
          [cvcContext]="
            props.isMultiSelect ? 'multi-select-item' : 'select-item'
          "
          [cvcMode]="props.isMultiSelect ? 'default' : 'closeable'"
          (cvcOnClose)="onTagClose$.next(selected.nzValue)"></cvc-entity-tag>
      </div>
    </ng-template>

    <!-- custom option template -->
    <ng-template
      #selectOptionExtra
      let-item
      let-searchString="searchStr">
      <span
        nz-typography
        nzType="secondary">
        <ng-container *ngIf="item.drugAliases.length > 0">
          <em>
            <span
              nz-typography
              nzType="secondary"
              [innerHtml]="
                item.drugAliases.join(', ') | highlightTypeahead: searchString
              "></span
          ></em>
        </ng-container>
      </span>
    </ng-template>
  </nz-col>
  <nz-col nzFlex="32px">
    <!-- quick-add button -->
    <a
      nz-button
      nzShape="circle"
      nzBlock
      nz-popover
      [nzPopoverContent]="addDrug"
      [nzPopoverTrigger]="'click'"
      ><span
        nz-icon
        nzType="plus-circle"
        nzTheme="outline"></span
    ></a>
  </nz-col>
</nz-row>

<!-- quick-add button's popup template -->
<ng-template
  #addDrug
  let-searchStr
  let-createMsg>
  <cvc-drug-quick-add-form
    [cvcSearchString]="searchStr"
    (cvcOnCreate)="onCreate$.next($event)">
  </cvc-drug-quick-add-form>
</ng-template>
