<nz-row [nzGutter]="[8, 8]">
  <nz-col nzFlex="auto">
    <cvc-entity-select
      [cvcSelectMode]="props.isMultiSelect ? 'tags' : 'default'"
      [cvcCustomTemplate]="selectedTemplate"
      [cvcFormControl]="formControl"
      [cvcFormlyAttributes]="field"
      [cvcEntityName]="props.entityName"
      [cvcSelectMessages]="props.selectMessages"
      [cvcResults]="result$ | ngrxPush"
      [cvcPlaceholder]="(placeholder$ | ngrxPush)!"
      [cvcShowError]="showError"
      [cvcDisabled]="!(onRequiresDrug$ | ngrxPush)"
      [cvcLoading]="isLoading$ | ngrxPush"
      [cvcOptionExtra]="optionExtra"
      [cvcOptionTrackBy]="optionTrackBy"
      (cvcOnSearch)="onSearch$.next($event)"
      [cvcModelChange]="props.change">
    </cvc-entity-select>
  </nz-col>
  <nz-col nzFlex="32px">
    <a
      nz-button
      nzShape="circle"
      nzBlock
      nz-popover
      [nzPopoverContent]="addDrug"
      [nzPopoverTrigger]="'click'"
      ><span
        nz-icon
        nzType="plus-circle"
        nzTheme="outline"></span
    ></a>
  </nz-col>
</nz-row>

<ng-template
  #selectedTemplate
  let-selected>
  <div class="ant-select-selection-item-content">
    <cvc-entity-tag
      [cvcCacheId]="'Drug:' + selected.nzValue"
      [cvcContext]="props.isMultiSelect ? 'multi-select-item' : 'default'"
      [cvcMode]="props.isMultiSelect ? 'default' : 'closeable'"
      (cvcOnClose)="onTagClose$.next(selected.nzValue)"></cvc-entity-tag>
  </div>
</ng-template>

<!-- option extra tpl to display list of aliases after tag -->
<ng-template
  #optionExtra
  let-item
  let-searchString="searchStr">
  <span
    nz-typography
    nzType="secondary">
    <ng-container *ngIf="item.drugAliases.length > 0">
      <em>
        <span
          nz-typography
          nzType="secondary"
          [innerHtml]="
            item.drugAliases.join(', ') | highlightTypeahead: searchString
          "></span
      ></em>
    </ng-container>
  </span>
</ng-template>

<!-- add drug tpl, to display when no results found for query -->
<ng-template
  #addDrug
  let-searchStr
  let-createMsg>
  <cvc-drug-quick-add-form
    [cvcSearchString]="searchStr"
    (cvcOnCreate)="onCreate$.next($event)">
  </cvc-drug-quick-add-form>
</ng-template>

