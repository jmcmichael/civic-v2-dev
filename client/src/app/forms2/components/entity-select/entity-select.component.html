<nz-select
  nzShowSearch
  nzServerSearch
  nzAllowClear
  [class.ng-dirty]="cvcShowError"
  [nzMode]="'tags'"
  [nzAutoClearSearchValue]="false"
  [nzPlaceHolder]="cvcPlaceholder"
  [formControl]="cvcFormControl"
  [formlyAttributes]="cvcFormlyAttributes"
  [nzOptionHeightPx]="30"
  [nzMode]="cvcSelectMode"
  [nzDisabled]="cvcDisabled"
  [nzLoading]="cvcLoading"
  [nzAllowClear]="cvcAllowClear"
  [nzCustomTemplate]="cvcCustomTemplate ? cvcCustomTemplate : null"
  [nzNotFoundContent]="notFound"
  (nzFocus)="cvcOnFocus.next()"
  (nzOnSearch)="onSearch$.next($event)"
  (ngModelChange)="
    cvcModelChange && cvcModelChange(cvcFormlyAttributes, $event)
  ">
  <ng-container *ngrxLet="onSearch$ as searchString">
    <ng-container *ngFor="let item of cvcResults">
      <nz-option
        nzCustomContent
        [nzValue]="item.id"
        [nzHide]="cvcSelectMode !== 'default' && cvcFormControl.value.includes(item.id)">
        <nz-space nzDirection="horizontal">
          <cvc-entity-tag
            *nzSpaceItem
            [cvcCacheId]="item.__typename + ':' + item.id"
            [cvcEmphasize]="searchString"></cvc-entity-tag>
          <ng-container
            *nzSpaceItem
            [ngTemplateOutlet]="cvcOptionExtra"
            [ngTemplateOutletContext]="{
              $implicit: item,
              searchStr: searchString
            }">
          </ng-container>
        </nz-space>
      </nz-option>
    </ng-container>
  </ng-container>
</nz-select>
<ng-template #notFound>
  <!-- loading msg -->
  <ng-container *ngIf="loadingMessage$ | ngrxPush as loadingMsg">
    <span
      nz-icon
      nzType="loading"
      class="loading-icon"></span>
    {{ loadingMsg }}
  </ng-container>

  <!-- 'enter search query' msg -->
  <ng-container *ngIf="focusMessage$ | ngrxPush as focusMsg">
    {{ focusMsg }}
  </ng-container>

  <!-- none found msg -->
  <ng-container *ngIf="notFoundMessage$ | ngrxPush as notFoundMsg">
    {{ notFoundMsg }}
  </ng-container>

  <!-- create new entity template-->
  <ng-container *ngIf="createMessage$ | ngrxPush as createMsg">
    <nz-alert
      nzType="info"
      [nzMessage]="createMsg"
      nzShowIcon></nz-alert>
    <ng-container
      *ngrxLet="onSearch$ as searchString"
      [ngTemplateOutlet]="cvcAddEntity"
      [ngTemplateOutletContext]="{
        $implicit: searchString,
        createMsg: createMsg
      }">
    </ng-container>
  </ng-container>
</ng-template>
